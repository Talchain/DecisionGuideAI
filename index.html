<!doctype html>
<!-- POC: The SPA will call window.__APP_MOUNTED__() ASAP; if it doesn't within ~2000ms (and CPU is quiet), we show the HTML safe screen. -->
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="x-build-id" content="%BUILD_ID%" />
    <title>DecisionGuide.AI - Better decisions faster</title>
    
    <style>
      /* Safe screen visible by default, hidden when React mounts */
      #poc-safe { 
        display: flex;
        opacity: 1;
        min-height: 100vh;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        transition: opacity 150ms ease-out;
      }
      #poc-safe[data-hidden="true"] { 
        display: none;
        opacity: 0;
      }
      /* Respect reduced motion preference */
      @media (prefers-reduced-motion: reduce) {
        #poc-safe { transition: none; }
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <!-- POC: HTML-level Safe Screen (zero-dependency, can't fail to parse) -->
    <div id="poc-safe" style="position:fixed;inset:0;background:#0b1e11;color:#d7ffe0;font-family:system-ui,Arial,sans-serif;z-index:99999;padding:16px;overflow:auto">
      <div style="background:#12b886;color:#052a1f;padding:8px 12px;border-radius:8px;display:inline-block;font-weight:600">
        PoC HTML Safe Screen
      </div>
      <div style="margin-top:12px;font-size:14px">
        <div>build: <span id="poc-build"></span></div>
        <div>edge: <span id="poc-edge"></span></div>
      </div>
      <pre id="poc-health" style="margin-top:12px;background:#062016;color:#abffcd;padding:12px;border-radius:8px;white-space:pre-wrap"></pre>
    </div>

    <script>
      // POC: Minimal inline script for build/edge display
      (function () {
        var build = document.querySelector('meta[name="x-build-id"]')?.content || new Date().toISOString();
        var edge = '/engine';
        var buildEl = document.getElementById('poc-build');
        var edgeEl = document.getElementById('poc-edge');
        var safeEl = document.getElementById('poc-safe');
        
        buildEl && (buildEl.textContent = build);
        edgeEl && (edgeEl.textContent = edge);
        
        // Add data-testid for E2E tests
        if (safeEl) safeEl.setAttribute('data-testid', 'safe-screen');
        
        // Health check (only if safe screen is visible)
        var healthEl = document.getElementById('poc-health');
        if (healthEl) {
          fetch(edge + '/health').then(function(r){ return r.json(); }).then(function(d){
            healthEl.textContent = 'OK via proxy\n' + JSON.stringify(d, null, 2);
          }).catch(function(){
            fetch('https://plot-lite-service.onrender.com/health').then(function(r){ return r.json(); }).then(function(d){
              healthEl.textContent = 'OK via direct\n' + JSON.stringify(d, null, 2);
            }).catch(function(e2){
              healthEl.textContent = 'FAIL\n' + String(e2);
            });
          });
        }
      })();
    </script>

    <script type="module">
      // === ultra-early flags & DOM refs ===
      const SAFE = document.getElementById('poc-safe');
      const ROOT = document.getElementById('root');
      window.__SAFE_DEBUG__ = { started: Date.now(), logs: [] };
      const dbg = (m, data) => {
        const line = `[BOOT] ${m}`;
        window.__SAFE_DEBUG__.logs.push({ t: Date.now(), m: line, data });
        try { console.log(line, data ?? ''); } catch {}
      };

      dbg('inline script start', { loc: location.href });
      if (!SAFE) dbg('WARN: #poc-safe missing!');
      if (!ROOT) dbg('WARN: #root missing or hidden?', { style: ROOT?.style });

      // === network/resource introspection helpers ===
      const listResources = (re) =>
        performance.getEntriesByType('resource')
          .filter(e => re.test(e.name)).map(e => e.name);

      // === the one true hider ===
      function hideSafe(reason) {
        if (!SAFE) return;
        SAFE.setAttribute('data-hidden','true');
        SAFE.style.display = 'none';  // Double-ensure hidden
        dbg('safe-screen hidden', { reason });
        try { performance.mark('safe-screen:hidden', { detail: { reason } }); } catch {}
        if (window.__SAFE_INTERVAL__) {
          clearInterval(window.__SAFE_INTERVAL__);
          window.__SAFE_INTERVAL__ = null;
        }
      }

      // === define the mount callback expected by the app ===
      // (works whether app CALLS it or only sets a boolean)
      window.__APP_MOUNTED__ = function mountedCallback(reason='app-mounted-callback'){
        dbg('__APP_MOUNTED__() called', { reason });
        hideSafe(reason);
        // also tag that app mounted for watchdogs/observers
        window.__APP_MOUNTED_FLAG__ = true;
      };

      // If the app merely flips a boolean later, poll for it briefly:
      window.__SAFE_INTERVAL__ = setInterval(() => {
        if (window.__APP_MOUNTED_FLAG__ === true) {
          dbg('detected boolean mount flag');
          hideSafe('boolean-flag-detected');
        }
      }, 100);

      // Also hide when #root actually receives children (DOM heuristic):
      try {
        if (ROOT) {
          const mo = new MutationObserver(() => {
            if (ROOT.childElementCount > 0) {
              dbg('root has children; hiding safe');
              hideSafe('root-has-children');
              mo.disconnect();
            }
          });
          mo.observe(ROOT, { childList: true });
        }
      } catch {}

      // === kick the app import with full tracing (only when not forceSafe) ===
      const qs = new URLSearchParams(location.search);
      const forced = qs.get('forceSafe') === '1';
      dbg('forceSafe?', { forced });

      if (forced) {
        dbg('forceSafe enabled: NOT importing app');
      } else {
        dbg('importing app entryâ€¦');

        import('/src/boot/reactApp.tsx')
          .then((mod) => {
            dbg('app entry import resolved', {
              reactAppRequests: listResources(/reactApp-|main-|react-vendor-|react-dom-|react-\w+/)
            });
            // If the app didn't call __APP_MOUNTED__ within 2.5s, we'll still hide when it renders (DOM observer),
            // otherwise the boolean poll above will flip it.
            setTimeout(() => {
              if (!window.__APP_MOUNTED_FLAG__) {
                dbg('NOTE: app import ok, but mount flag not set yet (waiting on DOM observer/poll)');
              }
            }, 2500);
          })
          .catch((err) => {
            console.error('[BOOT] app entry import FAILED', err);
            dbg('app entry import FAILED (keeping safe-screen visible)', { err: String(err) });
          });
      }

      // === absolute last resort watchdog so we never get stuck blank ===
      setTimeout(() => {
        if (!window.__APP_MOUNTED_FLAG__) {
          dbg('watchdog fired @3.5s; safe-screen stays visible unless user forced safe', { forced });
          // (safe-screen is already visible-by-default in your hotfix)
        }
      }, 3500);
    </script>
  </body>
</html>