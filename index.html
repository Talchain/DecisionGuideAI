<!doctype html>
<!-- POC: The SPA will call window.__APP_MOUNTED__() ASAP; if it doesn't within ~2000ms (and CPU is quiet), we show the HTML safe screen. -->
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="x-build-id" content="%BUILD_ID%" />
    <title>DecisionGuide.AI - Better decisions faster</title>
    
    <style>
      /* Safe screen visibility controlled by data attribute */
      #poc-safe { 
        display: none; 
        opacity: 0;
        transition: opacity 150ms ease-in;
      }
      #poc-safe[data-visible="true"] { 
        display: block; 
        animation: fadeIn 150ms ease-in forwards;
      }
      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      /* Respect reduced motion preference */
      @media (prefers-reduced-motion: reduce) {
        #poc-safe { transition: none; animation: none; }
        #poc-safe[data-visible="true"] { opacity: 1; }
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <!-- POC: HTML-level Safe Screen (zero-dependency, can't fail to parse) -->
    <div id="poc-safe" style="display:none;position:fixed;inset:0;background:#0b1e11;color:#d7ffe0;font-family:system-ui,Arial,sans-serif;z-index:99999;padding:16px;overflow:auto">
      <div style="background:#12b886;color:#052a1f;padding:8px 12px;border-radius:8px;display:inline-block;font-weight:600">
        PoC HTML Safe Screen
      </div>
      <div style="margin-top:12px;font-size:14px">
        <div>build: <span id="poc-build"></span></div>
        <div>edge: <span id="poc-edge"></span></div>
      </div>
      <pre id="poc-health" style="margin-top:12px;background:#062016;color:#abffcd;padding:12px;border-radius:8px;white-space:pre-wrap"></pre>
    </div>

    <script>
      // POC: HTML-level failsafe that can't fail to parse
      // POC: Contract: window.__APP_MOUNTED__() clears timeout, marks shown=true, hides overlay
      (function () {
        var shown = false;
        var SAFE_DELAY_MS = 2000; // Increased from 1200ms to handle production bundle load
        var SAFE_TO = null; // POC: store timeout id
        var build = document.querySelector('meta[name="x-build-id"]')?.content || new Date().toISOString();
        var edge = '/engine';
        var safeEl = document.getElementById('poc-safe');
        var healthEl = document.getElementById('poc-health');
        var buildEl = document.getElementById('poc-build');
        var edgeEl = document.getElementById('poc-edge');
        buildEl && (buildEl.textContent = build);
        edgeEl && (edgeEl.textContent = edge);
        
        // Add data-testid for E2E tests
        if (safeEl) safeEl.setAttribute('data-testid', 'safe-screen');
        
        // Quiet-window gate: track if CPU has been quiet for 500ms
        window.__NO_LONGTASKS_500MS__ = false;
        var lastLongTask = Date.now();
        var quietCheckInterval = null;
        
        // Monitor long tasks to avoid showing safe screen during active loading
        if (typeof PerformanceObserver !== 'undefined') {
          try {
            var observer = new PerformanceObserver(function(list) {
              lastLongTask = Date.now();
              window.__NO_LONGTASKS_500MS__ = false;
            });
            observer.observe({ entryTypes: ['longtask'] });
          } catch (e) {
            // PerformanceObserver not supported, continue without it
            window.__NO_LONGTASKS_500MS__ = true; // Graceful fallback
          }
        } else {
          // No PerformanceObserver support, assume quiet
          window.__NO_LONGTASKS_500MS__ = true;
        }
        
        // Check quiet window every 100ms
        quietCheckInterval = setInterval(function() {
          if (Date.now() - lastLongTask > 500) {
            window.__NO_LONGTASKS_500MS__ = true;
          }
        }, 100);

        function showSafe(reason){
          if (shown) return;
          
          var isQuiet = window.__NO_LONGTASKS_500MS__;
          var isVisible = document.visibilityState === 'visible';
          var isMounted = !!window.__APP_MOUNTED__;
          
          // Quiet-window gate: only show if CPU quiet, tab visible, and React not mounted
          if (!isQuiet || !isVisible || isMounted) {
            // Log when gate suppresses safe screen (measure effectiveness)
            try {
              performance.mark('safe-screen:suppressed', {
                detail: { reason: reason, quiet: isQuiet, visible: isVisible, mounted: isMounted }
              });
            } catch (e) {}
            return;
          }
          
          shown = true;
          
          // Clear interval - no longer need to poll
          try {
            if (quietCheckInterval) {
              clearInterval(quietCheckInterval);
              quietCheckInterval = null;
            }
          } catch (e) {}
          
          if (safeEl) {
            safeEl.setAttribute('data-visible', 'true');
            safeEl.style.display = 'block'; // Fallback for browsers without CSS
          }
          
          // Add Sentry breadcrumb for field triage
          try {
            if (window.Sentry && window.Sentry.addBreadcrumb) {
              window.Sentry.addBreadcrumb({
                category: 'safe-screen',
                level: 'info',
                message: 'safe-screen:shown',
                data: { reason: reason, quiet: isQuiet, visible: isVisible, mounted: isMounted }
              });
            }
          } catch (e) {}
          
          console.info('POC_HTML_SAFE: showing ('+reason+') build='+build+' edge='+edge);
          // try proxy first, then direct
          fetch(edge + '/health').then(function(r){ return r.json(); }).then(function(d){
            healthEl && (healthEl.textContent = 'OK via proxy\n' + JSON.stringify(d, null, 2));
            console.info('POC_HTML_SAFE: OK via proxy', d);
          }).catch(function(){
            fetch('https://plot-lite-service.onrender.com/health').then(function(r){ return r.json(); }).then(function(d){
              healthEl && (healthEl.textContent = 'OK via direct\n' + JSON.stringify(d, null, 2));
              console.info('POC_HTML_SAFE: OK via direct', d);
            }).catch(function(e2){
              healthEl && (healthEl.textContent = 'FAIL\n' + String(e2));
              console.error('POC_HTML_SAFE: FAIL', e2);
            });
          });
        }

        // Called by React once it mounts
        window.__APP_MOUNTED__ = function(){
          try {
            if (SAFE_TO) clearTimeout(SAFE_TO);       // POC: cancel timer
            shown = true;                              // POC: prevent future show
            
            // Clear interval - React mounted, no longer need to poll
            if (quietCheckInterval) {
              clearInterval(quietCheckInterval);
              quietCheckInterval = null;
            }
            
            if (safeEl) {
              safeEl.setAttribute('data-visible', 'false');
              safeEl.style.display = 'none'; // POC: ensure hidden
            }
            console.info('POC_HTML_SAFE: React mounted, no need for Safe Screen');
          } catch {}
        };
        
        // Check for forceSafe parameter - must happen BEFORE setting timeout
        var params = new URLSearchParams(window.location.search);
        var forceSafe = params.get('forceSafe') === '1';
        
        if (forceSafe) {
          showSafe('forced');
          // Don't set timeout or load React
        } else {
          // If React never tells us it mounted, show the safe screen
          SAFE_TO = setTimeout(function(){
            if (!shown) showSafe('timeout');
          }, SAFE_DELAY_MS);

          // Also show it on a hard error very early
          window.addEventListener('error', function(e){ 
            // Only show safe screen for critical errors, not React errors
            if (!shown && e.message && !e.message.includes('React')) {
              showSafe('early-error');
            }
          }, { once: true });
        }
      })();
    </script>

    <script type="module">
      // HARD AIR-GAP: Complete React isolation
      // This is the ONLY place that decides whether to load React
      (async () => {
        const params = new URLSearchParams(window.location.search);
        const forceSafe = params.get('forceSafe') === '1';
        
        if (forceSafe) {
          // Safe path: NEVER import React/Zustand/ReactFlow
          // Safe screen already shown by inline script
          return;
        }
        
        try {
          // App path: Load React via isolated boot entry
          const { bootReactApp } = await import('/src/boot/reactApp.tsx');
          await bootReactApp();
        } catch (err) {
          console.error('POC_HTML_SAFE: React boot failed', err);
          // Fallback will be handled by timeout in inline script
        }
      })();
    </script>
  </body>
</html>