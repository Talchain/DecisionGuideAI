<!doctype html>
<!-- POC: The SPA will call window.__APP_MOUNTED__() ASAP; if it doesn't within ~2000ms (and CPU is quiet), we show the HTML safe screen. -->
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="x-build-id" content="%BUILD_ID%" />
    <title>DecisionGuide.AI - Better decisions faster</title>
    
    <style>
      /* Safe screen visible by default, hidden when React mounts */
      #poc-safe { 
        display: flex;
        opacity: 1;
        min-height: 100vh;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        transition: opacity 150ms ease-out;
      }
      #poc-safe[data-hidden="true"] { 
        display: none;
        opacity: 0;
      }
      /* Respect reduced motion preference */
      @media (prefers-reduced-motion: reduce) {
        #poc-safe { transition: none; }
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <!-- POC: HTML-level Safe Screen (zero-dependency, can't fail to parse) -->
    <div id="poc-safe" style="position:fixed;inset:0;background:#0b1e11;color:#d7ffe0;font-family:system-ui,Arial,sans-serif;z-index:99999;padding:16px;overflow:auto">
      <div style="background:#12b886;color:#052a1f;padding:8px 12px;border-radius:8px;display:inline-block;font-weight:600">
        PoC HTML Safe Screen
      </div>
      <div style="margin-top:12px;font-size:14px">
        <div>build: <span id="poc-build"></span></div>
        <div>edge: <span id="poc-edge"></span></div>
      </div>
      <pre id="poc-health" style="margin-top:12px;background:#062016;color:#abffcd;padding:12px;border-radius:8px;white-space:pre-wrap"></pre>
    </div>

    <script>
      // POC: Minimal inline script for build/edge display
      (function () {
        var build = document.querySelector('meta[name="x-build-id"]')?.content || new Date().toISOString();
        var edge = '/engine';
        var buildEl = document.getElementById('poc-build');
        var edgeEl = document.getElementById('poc-edge');
        var safeEl = document.getElementById('poc-safe');
        
        buildEl && (buildEl.textContent = build);
        edgeEl && (edgeEl.textContent = edge);
        
        // Add data-testid for E2E tests
        if (safeEl) safeEl.setAttribute('data-testid', 'safe-screen');
        
        // Health check (only if safe screen is visible)
        var healthEl = document.getElementById('poc-health');
        if (healthEl) {
          fetch(edge + '/health').then(function(r){ return r.json(); }).then(function(d){
            healthEl.textContent = 'OK via proxy\n' + JSON.stringify(d, null, 2);
          }).catch(function(){
            fetch('https://plot-lite-service.onrender.com/health').then(function(r){ return r.json(); }).then(function(d){
              healthEl.textContent = 'OK via direct\n' + JSON.stringify(d, null, 2);
            }).catch(function(e2){
              healthEl.textContent = 'FAIL\n' + String(e2);
            });
          });
        }
      })();
    </script>

    <!-- PRE-REACT SAFE HIDE + BOOT TELEMETRY -->
    <script>
    (function () {
      window.__SAFE_DEBUG__ = window.__SAFE_DEBUG__ || { logs: [] };
      const log = (m, extra) => { __SAFE_DEBUG__.logs.push({ t: Date.now(), m, extra }); console.log('[BOOT]', m, extra ?? ''); };

      // define & immediately call the safe-screen hide so overlay never blocks React
      window.__APP_MOUNTED__ = function(reason = 'app-mounted-callback') {
        log('__APP_MOUNTED__()', { reason });
        const safe = document.getElementById('poc-safe');
        if (safe) { safe.setAttribute('data-hidden', 'true'); safe.style.display = 'none'; }
        window.__APP_MOUNTED_FLAG__ = true;
      };
      window.__APP_MOUNTED__('pre-react');
    })();
    </script>

    <!-- THE ONLY module script -->
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>