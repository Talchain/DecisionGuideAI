<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>PoC Static</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="x-build-id" content="%BUILD_ID%"><!-- POC: harmless if literal -->
  <style>
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial }
    .bar { background:#10b981; color:#fff; padding:10px 14px; font-weight:600 }
    .wrap { padding:14px 16px; display:grid; gap:16px; }
    .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center }
    .card { border:1px solid #e5e7eb; border-radius:8px; padding:12px }
    .label { font-weight:600; margin-right:6px }
    pre { background:#f6f8fa; padding:10px; overflow:auto; white-space:pre-wrap; }
    button { padding:8px 10px; border:1px solid #d1d5db; background:#f8f8f8; border-radius:6px; cursor:pointer }
    input[type="text"] { padding:8px 10px; border:1px solid #d1d5db; border-radius:6px; min-width: 380px; }
    .ok { color:#065f46; font-weight:600 }
    .fail { color:#991b1b; font-weight:600 }
    .hint { color:#6b7280; font-size:12px }
  </style>
</head>
<body>
  <div class="bar">PoC Static · build: <span id="b"></span></div>
  <div class="wrap">
    <div class="row">
      <span class="label">edge:</span>
      <span id="edge"></span>
      <span class="hint">(defaults to /engine — override via ?edge= )</span>
      <button id="copyLink" style="margin-left:auto">Copy Share Link</button>
      <button id="reset">Reset</button>
    </div>

    <!-- POC: Engine health checks -->
    <div class="card">
      <div class="row">
        <button id="proxy">Check Engine (proxy)</button>
        <button id="direct">Check Engine (direct)</button>
      </div>
      <pre id="out">{ "status": "idle" }</pre>
    </div>

    <!-- POC: Mock stream to demonstrate "live tokens" -->
    <div class="card">
      <div class="row">
        <button id="startStream">Start Mock Stream</button>
        <button id="stopStream">Stop</button>
      </div>
      <pre id="streamOut">[stream idle]</pre>
      <div class="hint">Simulated tokens appear here, 10–50 tokens with 50–150ms cadence.</div>
    </div>

    <!-- POC: Real GET to Engine (safe endpoint) -->
    <div class="card">
      <div class="row">
        <span class="label">GET</span>
        <input id="path" type="text" value="/draft-flows?template=pricing_change&seed=101" />
        <button id="fetchBtn">Fetch Flow (real)</button>
      </div>
      <pre id="fetchOut">[fetch idle]</pre>
      <div class="hint">Change the path if needed. It will call: &lt;edge&gt;+&lt;path&gt;</div>
    </div>

    <!-- POC: Bridge to SPA (optional) -->
    <div class="row">
      <button id="sandbox">Open SPA Sandbox</button>
      <span class="hint">Opens #/sandbox (import-free minimal panel). If it fails, this page stays.</span>
    </div>
  </div>

  <script>
    // POC: zero-dep utilities
    const $ = (id) => document.getElementById(id);
    const build = document.querySelector('meta[name="x-build-id"]')?.content || '(unknown)';
    const urlParams = new URLSearchParams(location.search);
    const edge = urlParams.get('edge') || '/engine';
    const defaultPath = '/draft-flows?template=pricing_change&seed=101';
    
    $('b').textContent = build;
    $('edge').textContent = edge;

    // POC: deep-link friendly - prefill path from ?path=
    const pathFromUrl = urlParams.get('path');
    if (pathFromUrl) {
      $('path').value = pathFromUrl;
    }

    // POC: loud acceptance log
    console.info('POC_STATIC:', { build, edge, path: $('path').value });

    const print = (el, label, v) => el.textContent = label + "\n" + (
      typeof v === 'string' ? v : JSON.stringify(v, null, 2)
    );

    // POC: Copy Share Link - includes ?edge= and ?path=
    $('copyLink').onclick = () => {
      try {
        const url = new URL(location.href);
        url.searchParams.set('edge', edge);
        url.searchParams.set('path', $('path').value);
        navigator.clipboard.writeText(url.toString()).then(() => {
          const orig = $('copyLink').textContent;
          $('copyLink').textContent = 'Copied!';
          setTimeout(() => { $('copyLink').textContent = orig; }, 1500);
        });
      } catch (e) {
        alert('Copy failed: ' + e);
      }
    };

    // POC: Reset - restore defaults and clear outputs
    $('reset').onclick = () => {
      $('path').value = defaultPath;
      $('out').textContent = '{ "status": "idle" }';
      $('streamOut').textContent = '[stream idle]';
      $('fetchOut').textContent = '[fetch idle]';
      // Update URL without reload
      const url = new URL(location.href);
      url.searchParams.delete('edge');
      url.searchParams.delete('path');
      history.replaceState(null, '', url.toString());
    };

    // --- Health checks with timing ---
    $('proxy').onclick = async () => {
      const t0 = performance.now();
      try {
        const r = await fetch(edge.replace(/\/$/, '') + '/health', { cache: 'no-store' });
        const data = await r.json();
        const ms = Math.round(performance.now() - t0);
        print($('out'), `OK via proxy (${ms} ms)`, data);
      } catch (e) {
        const ms = Math.round(performance.now() - t0);
        print($('out'), `FAIL via proxy (${ms} ms)`, String(e));
      }
    };
    $('direct').onclick = async () => {
      const t0 = performance.now();
      try {
        const r = await fetch('https://plot-lite-service.onrender.com/health', { cache: 'no-store' });
        const data = await r.json();
        const ms = Math.round(performance.now() - t0);
        print($('out'), `OK via direct (${ms} ms)`, data);
      } catch (e) {
        const ms = Math.round(performance.now() - t0);
        print($('out'), `FAIL via direct (${ms} ms)`, String(e));
      }
    };

    // auto-run proxy check
    $('proxy').click();

    // --- Mock stream (simulated SSE tokens) ---
    let streamTimer = null;
    $('startStream').onclick = () => {
      if (streamTimer) return;
      $('streamOut').textContent = '';
      const total = Math.floor(10 + Math.random() * 40); // 10–50 tokens
      let i = 0;
      streamTimer = setInterval(() => {
        i++;
        $('streamOut').textContent += (i === 1 ? '' : ' ') + '▌' + Math.random().toString(36).slice(2, 6);
        if (i >= total) {
          clearInterval(streamTimer); streamTimer = null;
          $('streamOut').textContent += '\n[done]';
        }
      }, 50 + Math.random() * 100); // 50–150ms cadence
    };
    $('stopStream').onclick = () => {
      if (streamTimer) { clearInterval(streamTimer); streamTimer = null; }
      $('streamOut').textContent += '\n[stopped]';
    };

    // --- Real GET to Engine (safe endpoint) with timing ---
    $('fetchBtn').onclick = async () => {
      const path = $('path').value.trim().replace(/^\/+/, '/');
      const url = edge.replace(/\/$/, '') + path;
      const t0 = performance.now();
      try {
        const r = await fetch(url, { cache: 'no-store' });
        const ct = r.headers.get('content-type') || '';
        if (!r.ok) throw new Error(r.status + ' ' + r.statusText);
        if (!ct.includes('application/json')) {
          const txt = await r.text().catch(()=> '[text read error]');
          throw new Error('Expected JSON, got: ' + ct + '\n' + txt.slice(0,200));
        }
        const data = await r.json();
        const ms = Math.round(performance.now() - t0);
        print($('fetchOut'), `OK ${path} (${ms} ms)`, data);
      } catch (e) {
        const ms = Math.round(performance.now() - t0);
        print($('fetchOut'), `FAIL ${path} (${ms} ms)`, String(e));
      }
    };

    // --- Bridge to SPA ---
    $('sandbox').onclick = () => { location.href = '/#/sandbox?from=poc-static'; };
  </script>
</body>
</html>
